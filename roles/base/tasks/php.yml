---
#@todo Check if it is useful for compiled php
- name: Check if php is installed
  command: /opt/php/bin/php -v
  register: php_installed
  failed_when: php_installed.rc < 0
  changed_when: php_installed.rc > 0

- name: Unzip the PHP source code file
  unarchive:
    src: roles/base/files/{{php.source_file}}
    dest: "{{ ansible_env.HOME}}/packages"
    creates: php.source.lock
  when: php_installed.rc > 0

- name: Install php
  script:  "roles/base/files/{{php.install_shell}}"
  args:
    creates: php.install.lock
  when: php_installed.rc > 0

- name: Check if symlink for php is created in /usr/bin
  stat:
    path: /usr/bin/php
  register: php_bin

- name: Create the symlinks for php commands in /usr/bin
  file:
    src: "/opt/php/bin/{{item.src}}"
    dest: "/usr/bin/{{item.dest}}"
    state: link
  with_items:
    - {src: 'php', dest: 'php'}
    - {src: 'php-cgi', dest: 'php-cgi'}
    - {src: 'phpize', dest: 'phpize'}
    - {src: 'php-config', dest: 'php-config'}
    - {src: 'phpdbg', dest: 'phpdbg'}
    - {src: 'pear', dest: 'pear'}
    - {src: 'peardev', dest: 'peardev'}
    - {src: 'pecl', dest: 'pecl'}
    - {src: 'phar', dest: 'phar'}
    - {src: 'phar.phar', dest: 'phar.phar'}
  when: php_bin.stat.exists == False

- name: Create the symlinks for php-fpm commands in /usr/bin
  file:
    src: "/opt/php/sbin/php-fpm"
    dest: "/usr/bin/php-fpm"
    state: link

- name: Check if composer is installed
  stat:
    path: /usr/local/bin/composer
  register: composer_bin

- name: Download Composer installer.
  get_url:
    url: https://getcomposer.org/installer
    dest: "{{ ansible_env.HOME}}/packages/composer-installer.php"
    mode: 0755
  when: composer_bin.stat.exists == False

- name: Run Composer installer.
  command: php composer-installer.php --filename=composer --install-dir=/usr/local/bin
  args:
    chdir: "{{ ansible_env.HOME}}/packages/"
    creates: composer.install.lock
  when: not composer_bin.stat.exists

- name: Create directory for php.ini file
  file:
    path: /opt/php/conf
    state: directory


